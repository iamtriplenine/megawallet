<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega Wallet - Connexion</title>

    
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://i.postimg.cc/NGpJ6343/IMG_8321.jpg">

<script>
  // Enregistrement du Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Service Worker OK'))
        .catch(err => console.log('Erreur SW', err));
    });
  }
</script>





    <link rel="icon" type="image/png" href="https://i.postimg.cc/NGpJ6343/IMG_8321.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { 
            --bg-body: #0f172a;       
            --bg-card: #1e293b;       
            --primary: #3b82f6;       
            --text-main: #f1f5f9;     
            --text-dim: #94a3b8;      
            --input-bg: #0f172a;      
            --border: #334155;        
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main);
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; margin: 0; 
        }

        .auth-card { 
            background: var(--bg-card); 
            padding: 35px 25px; 
            border-radius: 24px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.4); 
            width: 90%; max-width: 380px; 
            border: 1px solid var(--border);
        }

        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo-icon {
            background: linear-gradient(135deg, var(--primary), #6366f1);
            width: 55px; height: 55px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 10px;
        }

        h2 { text-align: center; margin-bottom: 25px; font-size: 19px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-dim); font-weight: 500; }
        
        input, select { 
            width: 100%; padding: 13px; 
            border: 1px solid var(--border); border-radius: 12px; 
            background-color: var(--input-bg); color: #fff;
            font-size: 14px; box-sizing: border-box; outline: none;
        }
        input:focus { border-color: var(--primary); }

        .btn-auth { 
            width: 100%; padding: 14px; background: var(--primary);
            color: white; border: none; border-radius: 12px; 
            font-size: 15px; font-weight: 700; cursor: pointer; margin-top: 10px;
        }

        .toggle-link { text-align: center; margin-top: 20px; font-size: 13px; color: var(--primary); cursor: pointer; }
        #message { text-align: center; margin-top: 15px; font-size: 13px; min-height: 20px; font-weight: 500; }
        
        .login-info { font-size: 11px; color: #fbbf24; text-align: center; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

<div class="auth-card">
    <div class="logo-container">
        <div class="logo-icon"><i class="fas fa-wallet" style="color: white; font-size: 24px;"></i></div>
        <div style="font-weight: 700; font-size: 22px;">Mega <span style="color:var(--primary)">Wallet</span></div>
    </div>

    <h2 id="auth-title">CrÃ©er un compte</h2>

    <div id="old-user-info" class="login-info">
        <i class="fas fa-info-circle"></i> Anciens : Connectez-vous avec votre numÃ©ro habituel sans indicatif.
    </div>

    <form id="authForm">
        <div id="group-username" class="form-group">
            <label><i class="fas fa-user"></i> Nom d'utilisateur</label>
            <input type="text" id="username" placeholder="Ex: Jean_Pro">
        </div>

        <div class="form-group" id="group-country">
            <label><i class="fas fa-globe"></i> Votre Pays (Nouveaux uniquement)</label>
            <select id="country-select" onchange="updateIndicatif()">
                <option value="" disabled selected>Choisir un pays</option>
                <option value="+225">ðŸ‡¨ðŸ‡® CÃ´te d'Ivoire (+225)</option>
                <option value="+226">ðŸ‡§ðŸ‡« Burkina Faso (+226)</option>
                <option value="+221">ðŸ‡¸ðŸ‡³ SÃ©nÃ©gal (+221)</option>
            </select>
        </div>

        <div class="form-group">
            <label><i class="fas fa-phone-alt"></i> NumÃ©ro de tÃ©lÃ©phone</label>
            <input type="tel" id="telephone" placeholder="Ex: 0708..." required>
        </div>

        <div class="form-group">
            <label><i class="fas fa-lock"></i> Mot de passe</label>
            <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>

        <div id="group-promo" class="form-group">
            <label><i class="fas fa-gift"></i> Code Promo</label>
            <input type="text" id="input_promo" placeholder="Optionnel">
        </div>

        <button type="submit" id="btn-text" class="btn-auth">S'inscrire</button>
    </form>
    
    <div id="message"></div>
    <div class="toggle-link" id="toggle-auth" onclick="toggleMode()">DÃ©jÃ  inscrit ? Se connecter</div>
</div>

<script>
    let isLoginMode = false;
    const API_URL = "https://backend-xxgf.onrender.com";

    if(localStorage.getItem('user')) {
        window.location.href = "user.html";
    }

    function updateIndicatif() {
        const select = document.getElementById('country-select');
        const phoneInput = document.getElementById('telephone');
        if(!isLoginMode) {
            phoneInput.value = select.value;
        }
    }

    function toggleMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').innerText = isLoginMode ? "Connexion" : "CrÃ©er un compte";
        document.getElementById('btn-text').innerText = isLoginMode ? "Se connecter" : "S'inscrire";
        document.getElementById('toggle-auth').innerText = isLoginMode ? "Nouveau ? CrÃ©er un compte" : "DÃ©jÃ  inscrit ? Se connecter";
        
        // Cacher le choix du pays en mode connexion pour permettre la saisie libre (anciens numÃ©ros)
        document.getElementById('group-username').style.display = isLoginMode ? 'none' : 'block';
        document.getElementById('group-promo').style.display = isLoginMode ? 'none' : 'block';
        document.getElementById('group-country').style.display = isLoginMode ? 'none' : 'block';
        document.getElementById('old-user-info').style.display = isLoginMode ? 'block' : 'none';
        
        document.getElementById('telephone').value = "";
        document.getElementById('message').innerText = "";
    }

    document.getElementById('authForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msgDiv = document.getElementById('message');
        
        // En mode inscription, on vÃ©rifie l'indicatif
        if(!isLoginMode && !document.getElementById('country-select').value) {
            msgDiv.style.color = "#f87171";
            msgDiv.innerText = "SÃ©lectionnez votre pays pour l'indicatif.";
            return;
        }

        const endpoint = isLoginMode ? '/login' : '/register';
        const data = {
            telephone: document.getElementById('telephone').value.trim(),
            password: document.getElementById('password').value.trim()
        };

        if (!isLoginMode) {
            data.username = document.getElementById('username').value.trim();
            data.promo_parrain = document.getElementById('input_promo').value.trim() || null;
        }

        msgDiv.style.color = "#3b82f6";
        msgDiv.innerText = "Chargement...";

        try {
            const response = await fetch(API_URL + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                msgDiv.style.color = "#4ade80";
                msgDiv.innerText = "SuccÃ¨s !";
                
                let sessionUser = isLoginMode ? result.user : {
                    id_public: result.id,
                    code_promo: result.promo,
                    telephone: data.telephone,
                    username: data.username,
                    balance: 0
                };
                sessionUser.password = data.password; 
                
                localStorage.setItem('user', JSON.stringify(sessionUser));
                setTimeout(() => { window.location.href = "user.html"; }, 800);
            } else {
                msgDiv.style.color = "#f87171";
                msgDiv.innerText = result.message || "Erreur de connexion.";
            }
        } catch (error) {
            msgDiv.style.color = "#f87171";
            msgDiv.innerText = "Serveur non joignable.";
        }
    });

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('ref')) { document.getElementById('input_promo').value = urlParams.get('ref'); }
</script>
</body>
</html>
